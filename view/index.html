<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music Recommender</title>
  <link rel="icon" href="/static/favicon.png" sizes="32x32" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800 font-sans">
  <div id="app" class="max-w-4xl mx-auto py-10 px-4">
    <!-- Song Listing -->
    <div id="listingPage">
      <h1 class="text-2xl sm:text-3xl font-bold mb-4 text-center">üéµ Music Engine</h1>

      <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
        <button onclick="nextPage()"
          class="px-5 py-2 bg-white border border-gray-300 rounded-lg shadow hover:bg-gray-100 transition">
          Load More
        </button>
        <button onclick="submitSelection()"
          class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
          Get Recommendations
        </button>
      </div>

      <div id="songList"
        class="p-4 space-y-3 max-h-[60vh] sm:max-h-[400px] bg-white border border-gray-200 rounded-lg overflow-y-scroll shadow-inner"
        style="scrollbar-gutter: stable;">
      </div>
    </div>

    <!-- Recommendations Page -->
    <div id="recommendationsPage" class="hidden">
      <h2 class="text-2xl font-semibold mb-6 text-center">üéß Recommended Songs</h2>
      <div class="text-center my-6">
        <button onclick="goBack()" class="px-5 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition">
          ‚Üê Back to Songs
        </button>
      </div>
      <div id="recommendationsList" class="space-y-3 bg-white p-4 border border-gray-200 rounded-lg shadow"></div>
    </div>

    <!-- Error Page -->
    <div id="errorPage" class="hidden">
      <h2 class="text-xl font-bold text-red-500 mb-4 text-center">‚ùå An error occurred. Please try again.</h2>
      <div class="text-center">
        <button onclick="goBack()" class="px-5 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition">
          ‚Üê Back
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 1;
    let songsFromAPI = [];
    let selectedTrackIds = [];
    const songsPerPage = 10;

    async function fetchSongs(page = 1) {
      const res = await fetch(`/songs?page=${page}&limit=${songsPerPage}`);
      const data = await res.json();
      songsFromAPI.push(...data.songs);
      renderSongs(songsFromAPI);
    }

    function renderSongs(songs) {
      const list = document.getElementById('songList');
      list.innerHTML = '';
      songs.forEach(song => {
        const isChecked = selectedTrackIds.includes(song.track_id);
        const songEl = document.createElement('div');
        songEl.className = 'flex items-start gap-3 p-3 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition';
        songEl.innerHTML = `
          <input type="checkbox" class="mt-1" ${isChecked ? 'checked' : ''} onchange="toggleSelection('${song.track_id}')" ${!isChecked && selectedTrackIds.length >= 5 ? 'disabled' : ''}>
          <span><strong>${song.track_name}</strong> by ${song.artist_name} <span class="text-sm text-gray-500">(${song.genre})</span></span>
        `;
        list.appendChild(songEl);
      });
    }

    function toggleSelection(trackId) {
      const index = selectedTrackIds.indexOf(trackId);
      if (index > -1) {
        selectedTrackIds.splice(index, 1);
      } else if (selectedTrackIds.length < 5) {
        selectedTrackIds.push(trackId);
      }
    }

    function nextPage() {
      currentPage++;
      fetchSongs(currentPage);
    }

    async function submitSelection() {
      if (selectedTrackIds.length === 0) return alert("Select at least 1 song.");
      try {
        const res = await fetch('/recommendations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ track_ids: selectedTrackIds })
        });

        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        showRecommendations(data.recommendations);
      } catch (e) {
        showError();
      }
    }

    function showRecommendations(recs) {
      document.getElementById('listingPage').classList.add('hidden');
      document.getElementById('errorPage').classList.add('hidden');
      const recsList = document.getElementById('recommendationsList');
      recsList.innerHTML = '';
      recs.forEach(song => {
        recsList.innerHTML += `
          <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
            <strong>${song.track_name}</strong> by ${song.artist_name} <span class="text-sm text-gray-500">(${song.genre})</span>
            <div class="text-sm text-blue-600 mt-1">${song.similarity}% similar</div>
          </div>
        `;
      });
      document.getElementById('recommendationsPage').classList.remove('hidden');
    }

    function showError() {
      document.getElementById('listingPage').classList.add('hidden');
      document.getElementById('recommendationsPage').classList.add('hidden');
      document.getElementById('errorPage').classList.remove('hidden');
    }

    function goBack() {
      document.getElementById('recommendationsPage').classList.add('hidden');
      document.getElementById('errorPage').classList.add('hidden');
      document.getElementById('listingPage').classList.remove('hidden');
      selectedTrackIds = [];
      fetchSongs(currentPage);
    }

    // Initial load
    fetchSongs();
  </script>
</body>

</html>